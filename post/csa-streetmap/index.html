<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Urban Logistics Network Simulation in Python | wh</title><meta name=keywords content="Python,SimPy,OSMnx,Leaflet.js"><meta name=description content="Building Anylogic&rsquo;s GIS-Feature w/ SimPy, OSMnx and Leaflet.js"><meta name=author content><link rel=canonical href=https://fladdimir.github.io/post/csa-streetmap/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fladdimir.github.io/icon.png><link rel=icon type=image/png sizes=16x16 href=https://fladdimir.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://fladdimir.github.io/icon.png><link rel=apple-touch-icon href=https://fladdimir.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fladdimir.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script data-goatcounter=https://fmghio.goatcounter.com/count async src=//gc.zgo.at/count.js></script><meta property="og:title" content="Urban Logistics Network Simulation in Python"><meta property="og:description" content="Building Anylogic&rsquo;s GIS-Feature w/ SimPy, OSMnx and Leaflet.js"><meta property="og:type" content="article"><meta property="og:url" content="https://fladdimir.github.io/post/csa-streetmap/"><meta property="og:image" content="https://fladdimir.github.io/post/csa-streetmap/featured.jpg"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-04-04T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-04T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fladdimir.github.io/post/csa-streetmap/featured.jpg"><meta name=twitter:title content="Urban Logistics Network Simulation in Python"><meta name=twitter:description content="Building Anylogic&rsquo;s GIS-Feature w/ SimPy, OSMnx and Leaflet.js"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fladdimir.github.io/post/"},{"@type":"ListItem","position":2,"name":"Urban Logistics Network Simulation in Python","item":"https://fladdimir.github.io/post/csa-streetmap/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Urban Logistics Network Simulation in Python","name":"Urban Logistics Network Simulation in Python","description":"Building Anylogic\u0026rsquo;s GIS-Feature w/ SimPy, OSMnx and Leaflet.js","keywords":["Python","SimPy","OSMnx","Leaflet.js"],"articleBody":"A really nice and quite unique feature of Anylogic is the possibility to include GIS-maps into simulation models. It allows to place elements on a map and move them along existing routes, based on real spatial information. This is cool because it can be used to simulate entire supply chains, including means to provide a great, tangible visualization for complex problems.\nThis previous project used Anylogic to evaluate different designs and delivery schemes for a more sustainable urban logistics network in the city center of Grenoble in France. The data-driven simulation model allows to quickly calculate KPIs for various transshipment node locations and different types of transport equipment in a multi-tier supply-chain network.\nFollowing the success of the feature, Anylogic even built anyLogistix, combining pre-built \u0026 customizable simulation models with a commercial solver for integrated supply chain planning \u0026 optimization.\nObviously, those commercial features come at a price, so let’s see whether this kind of model can also be realized with different means.\nThe simulation model of this post will be based on a mini-case-study.\nGet the repo from github.\nScenario \u0026 Scope Facing the fact that humanity gets more and more used to home-delivery of even everyday necessities, the small French bakery Die Patisserie in Hamburg-Altona wants to deliver sweet pastries to nearby customers.\n3 major purchasers were identified: the lost-and-found office Zentrales Fundbüro, Monkeys Music Club, and the publishing house Carlsen Verlag.\nCoordinates of the different locations:\nNode Name Lat Lon 1. PAT Die Patisserie 53.55668 9.92815 2. ZFB Zentrales Fundbüro (lost-and-found office) 53.55817 9.92829 3. MMC Monkeys Music Club 53.55706 9.93161 4. CAV Carlsen Verlag (publishing house) 53.55703 9.92684 For the sake of simplicity, the order in which nodes are visited is assumed to be fixed. The tour starts \u0026 ends at the patisserie:\nSimulation Model The simulation model for the simplistic scenario is created with:\nOSMnx/networkx for retrieving geo-information and calculating shortest-paths SimPy/Casymda for simulating the tour Leaflet.js for browser-based animation 1. OSMnx The awesome OSMnx package provides the possibility to obtain a networkx-graph representation of a street-network from OpenStreetMap with a single line of code. A relevant section for our scenario can be obtained by specifying center and distance for osm-nodes to be included:\nCENTER = (53.55668, 9.92815) DISTANCE = 300 G = ox.graph_from_point(CENTER, distance=DISTANCE, network_type='drive') OSMnx lets us pick the nearest osm-node for each of the 4 locations of the tour, and also offers convenient means to plot the network. Blue dots represent osm-nodes, connected by edges. The 4 relevant locations are shown in red:\nTo prepare all information needed by the simulation model, now all shortest paths between the 4 relevant nodes in the network are computed with networkx, and detailed information on all piece-wise linear segments for each route is included. The results are pickled and saved to disk to avoid fetching and recalculation for each run of the model (of course its kind to keep the load for the OSM-server as low as possible).\nThe above described approach could be improved, e.g. by automatically determining the area to be loaded from the given relevant locations. Instead of just picking the closest osm-node for each relevant location, it would also be more precise to first go for the closest edge in the network. And as the network size grows, it might be a better idea to directly query the shortest path between relevant nodes from the OSM-server, instead of fetching the network as a whole (the way Anylogic seems to do it).\n2. Casymda/SimPy Casymda provides block-based modeling of discrete-event-simulation models on top of SimPy.\nOur model can be characterized by a simple process:\nA truck is created at a parameterized Source and then processed at a custom DriveTour-block, which contains the logic for elapsing time according to the length of a route and the movement speed of the truck. It also contains the option to calculate intermediate locations for animation. The nodes to be visited are specified via the text-annotation stops=[\"ZFB\", \"MMC\", \"CAV\"].\nThe animation is implemented by exposing information and resources via flask (similar to the tilemap-animation described in the previous post).\n3. Leaflet.js To visualize the location of nodes and entities on a map, Leaflet only requires a few lines. For setting the rotation angle, there is the Rotated.Marker-plugin.\nmarker = L.marker(element.coords, { icon: new L.Icon({iconUrl: element.icon_path}) }).addTo(map); marker.bindPopup(element.text); marker.setRotationAngle(element.direction); Result To run the simulation via http://localhost:5000:\ndocker-compose up geo-web-animation The screencast below shows a complete tour of a truck visiting all nodes in the defined order (Patisserie - Lost-and-found - Monkey’s - Carlsen Publishing - Patisserie).\nThere should have been a video here but your browser does not seem to support it. The one-way street Völckersstraße is correctly taken into account when moving from Monkeys Music Club (3., right-most node) to Carlsen Verlag (4., left-most node).\nOf course there are numerous improvements and extensions imaginable, including e.g. the calculation of more realistic driving times based on actual speed limits which are already part of the available OSM-data.\n","wordCount":"829","inLanguage":"en","datePublished":"2020-04-04T00:00:00Z","dateModified":"2020-04-04T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://fladdimir.github.io/post/csa-streetmap/"},"publisher":{"@type":"Organization","name":"wh","logo":{"@type":"ImageObject","url":"https://fladdimir.github.io/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://fladdimir.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://fladdimir.github.io/tags/ title=/tags><span>/tags</span></a></li><li><a href=https://fladdimir.github.io/search title="/search (Alt + /)" accesskey=/><span>/search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fladdimir.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fladdimir.github.io/post/>Posts</a></div><h1 class=post-title>Urban Logistics Network Simulation in Python</h1><div class=post-meta><span title='2020-04-04 00:00:00 +0000 UTC'>April 4, 2020</span>&nbsp;·&nbsp;4 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#scenario--scope>Scenario & Scope</a></li><li><a href=#simulation-model>Simulation Model</a><ul><li><a href=#1-osmnx>1. OSMnx</a></li><li><a href=#2-casymdasimpy>2. Casymda/SimPy</a></li><li><a href=#3-leafletjs>3. Leaflet.js</a></li></ul></li><li><a href=#result>Result</a></li></ul></nav></div></details></div><div class=post-content><p>A really nice and quite unique feature of <a href=https://www.anylogic.com/>Anylogic</a> is the possibility to include GIS-maps into simulation models.
It allows to place elements on a map and move them along existing routes, based on real spatial information.
This is cool because it can be used to simulate entire supply chains, including means to provide a great, tangible visualization for complex problems.</p><p>This <a href=../../publication/i3m2017>previous project</a> used Anylogic to evaluate different designs and delivery schemes for a more sustainable urban logistics network in the city center of Grenoble in France.
The data-driven simulation model allows to quickly calculate KPIs for various transshipment node locations and different types of transport equipment in a multi-tier supply-chain network.</p><p>Following the success of the feature, Anylogic even built <a href=https://www.anylogistix.com/>anyLogistix</a>, combining pre-built & customizable simulation models with a commercial solver for integrated supply chain planning & optimization.</p><p>Obviously, those commercial features come at a price, so let&rsquo;s see whether this kind of model can also be realized with different means.</p><p>The simulation model of this post will be based on a mini-case-study.</p><blockquote><p><a href=https://github.com/fladdimir/csa-streetmap>Get the repo from github.</a></p></blockquote><p><img loading=lazy src=featured.jpg alt=featured></p><h2 id=scenario--scope>Scenario & Scope<a hidden class=anchor aria-hidden=true href=#scenario--scope>#</a></h2><p>Facing the fact that humanity gets more and more used to home-delivery of even everyday necessities, the small French bakery <a href=http://www.die-patisserie.de/de_DE>Die Patisserie</a> in Hamburg-Altona wants to deliver sweet pastries to nearby customers.</p><p>3 major purchasers were identified: the lost-and-found office <a href=https://www.hamburg.de/altona/fundbuero/>Zentrales Fundbüro</a>, <a href=https://www.monkeys-hamburg.de/>Monkeys Music Club</a>, and the publishing house <a href=https://www.carlsen.de/node/18749>Carlsen Verlag</a>.</p><p>Coordinates of the different locations:</p><table><thead><tr><th></th><th>Node</th><th>Name</th><th>Lat</th><th>Lon</th></tr></thead><tbody><tr><td>1.</td><td>PAT</td><td>Die Patisserie</td><td>53.55668</td><td>9.92815</td></tr><tr><td>2.</td><td>ZFB</td><td>Zentrales Fundbüro (lost-and-found office)</td><td>53.55817</td><td>9.92829</td></tr><tr><td>3.</td><td>MMC</td><td>Monkeys Music Club</td><td>53.55706</td><td>9.93161</td></tr><tr><td>4.</td><td>CAV</td><td>Carlsen Verlag (publishing house)</td><td>53.55703</td><td>9.92684</td></tr></tbody></table><p>For the sake of simplicity, the order in which nodes are visited is assumed to be fixed. The tour starts & ends at the patisserie:</p><p><img loading=lazy src=img/stations.jpg alt=tour-stops></p><hr><h2 id=simulation-model>Simulation Model<a hidden class=anchor aria-hidden=true href=#simulation-model>#</a></h2><p>The simulation model for the simplistic scenario is created with:</p><ul><li>OSMnx/networkx for retrieving geo-information and calculating shortest-paths</li><li>SimPy/Casymda for simulating the tour</li><li>Leaflet.js for browser-based animation</li></ul><h3 id=1-osmnx>1. OSMnx<a hidden class=anchor aria-hidden=true href=#1-osmnx>#</a></h3><p>The awesome <a href=https://github.com/gboeing/osmnx>OSMnx</a> package provides the possibility to obtain a networkx-graph representation of a street-network from OpenStreetMap with a single line of code.
A relevant section for our scenario can be obtained by specifying center and distance for osm-nodes to be included:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>CENTER</span> <span class=o>=</span> <span class=p>(</span><span class=mf>53.55668</span><span class=p>,</span> <span class=mf>9.92815</span><span class=p>)</span>  
</span></span><span class=line><span class=cl><span class=n>DISTANCE</span> <span class=o>=</span> <span class=mi>300</span>
</span></span><span class=line><span class=cl><span class=n>G</span> <span class=o>=</span> <span class=n>ox</span><span class=o>.</span><span class=n>graph_from_point</span><span class=p>(</span><span class=n>CENTER</span><span class=p>,</span> <span class=n>distance</span><span class=o>=</span><span class=n>DISTANCE</span><span class=p>,</span> <span class=n>network_type</span><span class=o>=</span><span class=s1>&#39;drive&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>OSMnx lets us pick the nearest osm-node for each of the 4 locations of the tour, and also offers convenient means to plot the network.
Blue dots represent osm-nodes, connected by edges.
The 4 relevant locations are shown in red:</p><p><img loading=lazy src=img/osmnx_plot.jpg alt=OSMnx-graph-plot></p><p>To prepare all information needed by the simulation model, now all shortest paths between the 4 relevant nodes in the network are computed with networkx, and detailed information on all piece-wise linear segments for each route is included.
The results are pickled and saved to disk to avoid fetching and recalculation for each run of the model (of course its kind to keep the load for the OSM-server as low as possible).</p><p>The above described approach could be improved, e.g. by automatically determining the area to be loaded from the given relevant locations.
Instead of just picking the closest osm-node for each relevant location, it would also be more precise to first go for the closest edge in the network.
And as the network size grows, it might be a better idea to directly query the shortest path between relevant nodes from the OSM-server, instead of fetching the network as a whole (the way Anylogic seems to do it).</p><h3 id=2-casymdasimpy>2. Casymda/SimPy<a hidden class=anchor aria-hidden=true href=#2-casymdasimpy>#</a></h3><p><a href=../casymda>Casymda</a> provides block-based modeling of discrete-event-simulation models on top of <a href=https://pypi.org/project/simpy/>SimPy</a>.<br>Our model can be characterized by a simple process:</p><p><img loading=lazy src=img/diagram.svg alt=bpmn-process></p><p>A truck is created at a parameterized <code>Source</code> and then processed at a custom <code>DriveTour</code>-block, which contains the logic for elapsing time according to the length of a route and the movement speed of the truck. It also contains the option to calculate intermediate locations for animation. The nodes to be visited are specified via the text-annotation <code>stops=["ZFB", "MMC", "CAV"]</code>.</p><p>The animation is implemented by exposing information and resources via flask (similar to the <em>tilemap-animation</em> described in the previous post).</p><h3 id=3-leafletjs>3. Leaflet.js<a hidden class=anchor aria-hidden=true href=#3-leafletjs>#</a></h3><p>To visualize the location of nodes and entities on a map, <a href=https://leafletjs.com/>Leaflet</a> only requires a few lines. For setting the rotation angle, there is the <a href=https://github.com/bbecquet/Leaflet.RotatedMarker>Rotated.Marker-plugin</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>marker</span> <span class=o>=</span> <span class=nx>L</span><span class=p>.</span><span class=nx>marker</span><span class=p>(</span><span class=nx>element</span><span class=p>.</span><span class=nx>coords</span><span class=p>,</span> <span class=p>{</span> <span class=nx>icon</span><span class=o>:</span> <span class=k>new</span> <span class=nx>L</span><span class=p>.</span><span class=nx>Icon</span><span class=p>({</span><span class=nx>iconUrl</span><span class=o>:</span> <span class=nx>element</span><span class=p>.</span><span class=nx>icon_path</span><span class=p>})</span> <span class=p>}).</span><span class=nx>addTo</span><span class=p>(</span><span class=nx>map</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>marker</span><span class=p>.</span><span class=nx>bindPopup</span><span class=p>(</span><span class=nx>element</span><span class=p>.</span><span class=nx>text</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>marker</span><span class=p>.</span><span class=nx>setRotationAngle</span><span class=p>(</span><span class=nx>element</span><span class=p>.</span><span class=nx>direction</span><span class=p>);</span>
</span></span></code></pre></div><hr><h2 id=result>Result<a hidden class=anchor aria-hidden=true href=#result>#</a></h2><p>To run the simulation via <a href=http://localhost:5000>http://localhost:5000</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>docker-compose up geo-web-animation
</span></span></code></pre></div><p>The <a href=img/tour.mp4>screencast below</a> shows a complete tour of a truck visiting all nodes in the defined order (Patisserie - Lost-and-found - Monkey&rsquo;s - Carlsen Publishing - Patisserie).</p><video style=width:100% autoplay loop controls src=img/tour.mp4 type=video/mp4>
There should have been a video here but your browser does not seem
to support it.</video><blockquote><p>The one-way street <em>Völckersstraße</em> is correctly taken into account when moving from <em>Monkeys Music Club</em> (3., right-most node) to <em>Carlsen Verlag</em> (4., left-most node).</p></blockquote><p>Of course there are numerous improvements and extensions imaginable, including e.g. the calculation of more realistic driving times based on actual speed limits which are already part of the available OSM-data.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://fladdimir.github.io/tags/python/>Python</a></li><li><a href=https://fladdimir.github.io/tags/simpy/>SimPy</a></li><li><a href=https://fladdimir.github.io/tags/osmnx/>OSMnx</a></li><li><a href=https://fladdimir.github.io/tags/leaflet.js/>Leaflet.js</a></li></ul><nav class=paginav><a class=prev href=https://fladdimir.github.io/post/csa-simulation-based-sc-forecast/><span class=title>« Prev</span><br><span>Real-time Simulation-based Supply-Chain Analytics</span></a>
<a class=next href=https://fladdimir.github.io/post/tugger-routing/><span class=title>Next »</span><br><span>Digital Twin for Assembly Line Material Provisioning Planning</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://fladdimir.github.io/>wh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>