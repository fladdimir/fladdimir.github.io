<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Green-Light Optimized Speed Advisory for Cycling in Hamburg | wh</title><meta name=keywords content="Java,Spring,React,TypeScript,Leaflet.js,Tracing,MQTT,NodeJS,OGC SensorThings API"><meta name=description content="A proof-of-concept web app to reduce traffic-light waiting time"><meta name=author content><link rel=canonical href=https://fladdimir.github.io/post/glosa/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fladdimir.github.io/icon.png><link rel=icon type=image/png sizes=16x16 href=https://fladdimir.github.io/icon.png><link rel=icon type=image/png sizes=32x32 href=https://fladdimir.github.io/icon.png><link rel=apple-touch-icon href=https://fladdimir.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fladdimir.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script data-goatcounter=https://fmghio.goatcounter.com/count async src=//gc.zgo.at/count.js></script><meta property="og:title" content="Green-Light Optimized Speed Advisory for Cycling in Hamburg"><meta property="og:description" content="A proof-of-concept web app to reduce traffic-light waiting time"><meta property="og:type" content="article"><meta property="og:url" content="https://fladdimir.github.io/post/glosa/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-06-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-06-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Green-Light Optimized Speed Advisory for Cycling in Hamburg"><meta name=twitter:description content="A proof-of-concept web app to reduce traffic-light waiting time"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fladdimir.github.io/post/"},{"@type":"ListItem","position":2,"name":"Green-Light Optimized Speed Advisory for Cycling in Hamburg","item":"https://fladdimir.github.io/post/glosa/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Green-Light Optimized Speed Advisory for Cycling in Hamburg","name":"Green-Light Optimized Speed Advisory for Cycling in Hamburg","description":"A proof-of-concept web app to reduce traffic-light waiting time","keywords":["Java","Spring","React","TypeScript","Leaflet.js","Tracing","MQTT","NodeJS","OGC SensorThings API"],"articleBody":"Over the last years, the city of Hamburg (Germany) has put significant work into their Urban Data Platform and the geo-portal, improving the accessibility of various data sources.\nIn particular, the Traffic Lights Data Hamburg beta API provides access to real-time signal data of traffic-light systems for a large number of intersections in the city center.\nGreen-light optimized speed advisory The idea of green-light optimized speed advisory (“GLOSA”) is to reduce unnecessary stops and accelerations by calculating reasonable movement speeds based on expected future green-light periods of upcoming traffic-lights.\nExamples:\nGevas launched their app traffic pilot which is available i.a. in Duesseldorf, Frankfurt, Salzburg and Kassel Audi provides a GLOSA traffic assistant for their cars in selected cities (i.a. Ingolstadt, Duesseldorf, and New York (US)) Available traffic-lights data in Hamburg The geo-portal is an interactive map which can visualize some of the data made available by the city of Hamburg.\nThe screenshot below shows real-time traffic-light data of the intersection Fruchtallee / Doormannsweg:\nColors indicate the current signal of traffic-lights of different lanes.\nCorresponding data is provided for about 800 of 1770 traffic-lights in Hamburg:\nThe data is made available on https://tld.iot.hamburg.de/v1.1 via the standard OGC SensorThings API which is described in detail e.g. here (usage guide).\nThis paper gives an overview on the system architecture and underlying infrastructure.\nThe map below shows a sample cycling route through the city as well as markers for all traffic-lights for which real-time data is currently available:\nOverall, 13 out of 21 traffic-lights on the route provide real-time data (some are currently disabled due to ongoing construction work, and some may just be too small to be prioritized when planning corresponding IoT equipment).\nTo give an impression of provided traffic-light real-time data, the following bokeh-chart shows some historical data for the relevant primary signal (south -\u003e north) of the above-mentioned intersection Fruchtallee / Doormannsweg (the most westward on the route, with ID 813_19, Datastream-ID 50850), on a typical morning (Friday, 19.05.2023, 6:00-8:00 UTC):\n(\u003e interactive chart)\nThe y-axis shows the duration of a phase over time (x-axis). Blue indicates the length of complete cycles (red-to-red), and is calculated from the sum of the durations of the different phases, drawn in their corresponding colors. Dashed lines indicate average values over the time-period (arithmetic mean).\nOn average, a complete cycle took about 90s and the traffic-light showed red about 63s, green for about 23s, and the transitions (amber / red-amber) only account for 3s and 1s respectively.\nThis difference is explained by the fact that the analyzed traffic-light is pointing towards the lanes going from south to north, while the majority of (car-)traffic at that time can be expected to go from west to east towards the city center.\nThe observations show a number of larger deviations from the mean, with green phases being almost twice as long as normal (over 40s, at 06:30 and 07:20), followed by accordingly shorter red phases (only slightly longer than 40s).\nThese deviations can be explained by the dynamic traffic-lights control, which may extend certain phase durations e.g. to account for bus signal requests (bus priorization), or when detecting extraordinarily high volumes of car traffic going into a specific direction.\nAccording to a sample of observations, recent data is online available via the API in about 1-2s after a signal phase change.\nIn addition to the described real-time traffic-light data for car signals, the API also provides further information e.g. on car detectors, bus signal requests, pedestrian signals, and pedestrian signal requests.\nProof-of-Concept: A simple GLOSA web-app The app allows a mobile web-client to request speed recommendations:\nMain flow of information:\na client requests a speed-advice, submitting its current location, movement speed, and trip-id based on the trip-id the server can lookup the predefined route and determine the next upcoming traffic-light the latest signal-phase change times can be queried from the traffic-lights-data API based on the received observations, a forecast of future phase changes can be created the forecast is used to determine the movement speed necessary to catch the next reachable green phase and that information is returned to the client whenever the client location updates, a new GLOSA-request is sent (see step 1., limited to at most 1 request per second) For the proof-of-concept, the initial route configuration is done manually by importing a defined route (.gpx format), and by identifying relevant traffic-light IDs with help of the geo-portal.\nThe next screenshot shows a minimal web UI which provides information about the current location of the device, the next traffic-light (currently showing red), as well as the speed recomendation (“slow down, its not getting green anytime soon..”):\nAfter slowing down, the signal switched to green a few seconds later, and the current speed is now sufficient to catch the phase:\nManual testing (speed set to 20 km/h):\nThere should have been a video here but your browser does not seem to support it. Used technologies Client built with React Material UI components, react-router, Leaflet for map display and interaction (via react-leaflet), and the browser Geolocation API (consent and secure context required).\nSince the Geolocation API does not work in the background a wakelock can be requested.\nServer-side: nginx for basic authentication, ssl-termination, static frontend file serving, and /api-request forwarding.\nA “main backend service” is used for central calculations and the “orchestration” of auxiliary services, built with Spring Boot (which recently released the amazing support for compiling to a native-image, even though some stumbling blocks remain).\nAccess to the latest traffic-light data using express running on node.js.\nFuture phase change times are forecasted based on the (naive) expectation of average-length phases, implemented in Python with pandas and exposed via flask.\nFor simple testing during development, the public localtunnel service can be used.\n(The repository is available on github).\nPerformance considerations As the sketched system relies on frequent client-server-communication (~1 request per client per second), performant request handling is important.\nFor an analysis of server-side request processing, the open telemetry project provides standard tooling to gather tracing information for nested requests to different backend services (database, traffic-lights data API, forecasting service).\nInstrumentation support for automatic trace collection and forwarding to a tracing analysis backend are available for many popular languages / frameworks. For the main Java service, the Java instrumentation agent is used, which injects bytecode so that tracing information is automatically collected for popular frameworks / libraries without any code changes. Similar auto-instrumentation functionality is available for the node.js based traffic-lights data API proxy service, and for the Python-based forecast-service.\nProcessing of a single GLOSA-request:\nThe complete POST to the main backend (locationtracking-0.0.1-SNAPSHOT) takes 105ms to complete, starting with a database accesses (first ~10ms), followed by a long-running 69ms call to the traffic-lights data API proxy service (tld_api), and a 14ms call to the forecasting service (tld_forecast). The main share of the overall request processing time is caused by the call to the external traffic-lights data API (68ms), out of which creating the TCP connection and completing the TLS handshake alone require 39ms.\nTo improve performance and efficiency of the external data API access, the subscription feature of the sensorthings API is used. Apart from the normal HTTP-API to access historical data of traffic-light signal phase changes, a (websocket-based) MQTT-API allows to subscribe to new updates of specific traffic-lights.\nan initial request of the last N signal phase change timestamps causes a regular HTTP request to the external API to fetch the required observations furthermore, the received data is cached, and an MQTT-subscription for future updates is created each received update is used to update the cache (evicting the oldest entry) each following client-request for the same traffic-light data can now immediately be answered with locally cached data, without causing any external API request after a configurable time without any client requests for data of a specific traffic-light (e.g. 60s), its subscription is canceled and its cache is cleared (a following client request is again causing an initial external request (1.)) The following screenshot shows the processing of a subsequent client request for the same traffic-light data:\nThe request to the tld_api is processed within 3ms without any external call.\nTo reduce the calculation effort of the route snapping, the index of the last reached route-segment is submitted back to the client as part of the response, and the information is included into the following request. This way, the number of checked route-segments can be limited (based on the assumption that a client is not expected to move backwards on a route).\nExperimental evaluation To quantify the effects of using the GLOSA app, the geolocation and speed data is sent with each request was persisted for analysis.\nSpeed profile of a bike ride without GLOSA speed recommendations:\nThe trip had a duration of 00:32:16, and during this time 1,937 samples were collected (one GPS update per second).\nThe theoretical distance measured on a map is 10.7 km, the total sum of the distances between all sampled locations is 11.1 km (slightly longer, probably due to GPS inaccuracies and seemingly “less straight” movements).\nThe average speed was 5.53 m/s (19.90 km/h). This is close to the average speed calculated from the 1,937 speed samples (5.38 m/s), so the measurements seem to be quite accurate.\nThe maximum measured speed was 9.30 m/s (33.47 km/h), the share of samples with a measured speed below 1 km/h (likely stops) was 10.8%.\nTrip with GLOSA recommendations:\nThe share of speed measurements below 1 km/h is still 9.2% - a difference of 1.6 percentage points which may not be interpreted to be of any significance.\nAn extended evaluation should be based on a larger number of trips. (Furthermore, the experiment itself was probably also negatively influenced by existing experience on the typical phase lengths.)\nThe effect of using the GLOSA app is negatively influenced by:\noutdated traffic light data for some traffic lights (the “real-time” data is so old that no meaningful predications can be made) badly correlated traffic lights (no matter how slow/quick you try to go, between some traffic lights stops are almost inevitable; the phases seem to be optimized for a limited number of cars driving 50 km/h) “Bedarfsampeln” (one traffic light on the route only switches to green upon manual triggering, thus also causing unavoidable stops) volatile phase lenghts (forecasts purely based on historical data tend to be rather inaccurate, given the dynamic, adaptive traffic control) Especially the last point causes a particularly frustrating experience in case a green phase could actually have easily been catched when not following a recommendation.\n","wordCount":"1751","inLanguage":"en","datePublished":"2023-06-26T00:00:00Z","dateModified":"2023-06-26T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://fladdimir.github.io/post/glosa/"},"publisher":{"@type":"Organization","name":"wh","logo":{"@type":"ImageObject","url":"https://fladdimir.github.io/icon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://fladdimir.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://fladdimir.github.io/tags/ title=/tags><span>/tags</span></a></li><li><a href=https://fladdimir.github.io/search title="/search (Alt + /)" accesskey=/><span>/search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fladdimir.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fladdimir.github.io/post/>Posts</a></div><h1 class=post-title>Green-Light Optimized Speed Advisory for Cycling in Hamburg</h1><div class=post-meta><span title='2023-06-26 00:00:00 +0000 UTC'>June 26, 2023</span>&nbsp;·&nbsp;9 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#green-light-optimized-speed-advisory>Green-light optimized speed advisory</a></li><li><a href=#available-traffic-lights-data-in-hamburg>Available traffic-lights data in Hamburg</a></li><li><a href=#proof-of-concept-a-simple-glosa-web-app>Proof-of-Concept: A simple GLOSA web-app</a><ul><li><a href=#used-technologies>Used technologies</a></li><li><a href=#performance-considerations>Performance considerations</a></li><li><a href=#experimental-evaluation>Experimental evaluation</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>Over the last years, the city of Hamburg (Germany) has put significant work into their <a href=https://www.en.urbandataplatform.hamburg/>Urban Data Platform</a> and the <a href=https://geoportal-hamburg.de/geo-online/>geo-portal</a>, improving the accessibility of various data sources.</p><p>In particular, the <a href=https://tld.iot.hamburg.de/v1.1>Traffic Lights Data Hamburg beta API</a> provides access to real-time signal data of traffic-light systems for a large number of intersections in the city center.</p><h2 id=green-light-optimized-speed-advisory>Green-light optimized speed advisory<a hidden class=anchor aria-hidden=true href=#green-light-optimized-speed-advisory>#</a></h2><p>The idea of green-light optimized speed advisory (&ldquo;GLOSA&rdquo;) is to reduce unnecessary stops and accelerations by calculating reasonable movement speeds based on expected future green-light periods of upcoming traffic-lights.</p><p>Examples:</p><ul><li><a href=https://www.gevas.eu/>Gevas</a> launched their app <a href=https://www.trafficpilot.eu/>traffic pilot</a> which is available i.a. in Duesseldorf, Frankfurt, Salzburg and Kassel</li><li><a href=https://www.audi-mediacenter.com/de/pressemitteilungen/audi-vernetzt-sich-mit-ampeln-in-duesseldorf-12516>Audi</a> provides a GLOSA traffic assistant for their cars in selected cities (i.a. Ingolstadt, Duesseldorf, and New York (US))</li></ul><h2 id=available-traffic-lights-data-in-hamburg>Available traffic-lights data in Hamburg<a hidden class=anchor aria-hidden=true href=#available-traffic-lights-data-in-hamburg>#</a></h2><p>The <a href=https://geoportal-hamburg.de/geo-online/>geo-portal</a> is an interactive map which can visualize some of the data made available by the city of Hamburg.</p><p>The screenshot below shows real-time traffic-light data of the intersection Fruchtallee / Doormannsweg:</p><p><img loading=lazy src=./img/geoportal_primary_signal.jpg alt=geo-portal-primary-signal></p><p>Colors indicate the current signal of traffic-lights of different lanes.</p><p>Corresponding data is provided for about 800 of 1770 traffic-lights in Hamburg:</p><p><img loading=lazy src=img/tlf_2_0.jpg alt=tlf-2-0></p><p>The data is made available on <a href=https://tld.iot.hamburg.de/v1.1>https://tld.iot.hamburg.de/v1.1</a> via the standard <a href=https://www.ogc.org/standard/sensorthings/>OGC SensorThings API</a> which is described in detail e.g. <a href=https://daten-hamburg.de/tlf_public/TLD_UsageGuide_V1.1.pdf>here</a> (usage guide).<br><a href=https://www.researchgate.net/publication/349105749_Urban_Data_Platform_Hamburg_Integration_von_Echtzeit_IoT-Daten_mittels_SensorThings_API>This paper</a> gives an overview on the system architecture and underlying infrastructure.</p><p>The map below shows a sample cycling route through the city as well as markers for all traffic-lights for which real-time data is currently available:</p><p><img loading=lazy src=img/route-traffic-lights.jpg alt=route-traffic-lights></p><p>Overall, 13 out of 21 traffic-lights on the route provide real-time data (some are currently disabled due to ongoing construction work, and some may just be too small to be prioritized when planning corresponding IoT equipment).</p><p>To give an impression of provided traffic-light real-time data, the following <a href=https://github.com/bokeh/bokeh>bokeh</a>-chart shows some historical data for the relevant primary signal (south -> north) of the above-mentioned intersection Fruchtallee / Doormannsweg (the most westward on the route, with ID 813_19, Datastream-ID 50850), on a typical morning (Friday, 19.05.2023, 6:00-8:00 UTC):</p><p><a href=img/chart/fra_doo_19052023_08_10.html><img loading=lazy src=img/fra_doo_19052023_08_10.png alt=traffic-light-phase-chart></a>
(<a href=img/chart/fra_doo_19052023_08_10.html>> interactive chart</a>)</p><p>The y-axis shows the duration of a phase over time (x-axis).
Blue indicates the length of complete cycles (red-to-red), and is calculated from the sum of the durations of the different phases, drawn in their corresponding colors. Dashed lines indicate average values over the time-period (arithmetic mean).</p><p>On average, a complete cycle took about 90s and the traffic-light showed red about 63s, green for about 23s, and the transitions (amber / red-amber) only account for 3s and 1s respectively.<br>This difference is explained by the fact that the analyzed traffic-light is pointing towards the lanes going from south to north, while the majority of (car-)traffic at that time can be expected to go from west to east towards the city center.</p><p>The observations show a number of larger deviations from the mean, with green phases being almost twice as long as normal (over 40s, at 06:30 and 07:20), followed by accordingly shorter red phases (only slightly longer than 40s).<br>These deviations can be explained by the dynamic traffic-lights control, which may extend certain phase durations e.g. to account for bus signal requests (bus priorization), or when detecting extraordinarily high volumes of car traffic going into a specific direction.</p><p>According to a sample of observations, recent data is online available via the API in about 1-2s after a signal phase change.</p><p>In addition to the described real-time traffic-light data for car signals, the API also provides further information e.g. on car detectors, bus signal requests, pedestrian signals, and pedestrian signal requests.</p><h2 id=proof-of-concept-a-simple-glosa-web-app>Proof-of-Concept: A simple GLOSA web-app<a hidden class=anchor aria-hidden=true href=#proof-of-concept-a-simple-glosa-web-app>#</a></h2><p>The app allows a mobile web-client to request speed recommendations:</p><p><a href=img/components.drawio.png><img loading=lazy src=img/components.drawio.png alt=components></a></p><p>Main flow of information:</p><ol><li>a client requests a speed-advice, submitting its current location, movement speed, and trip-id</li><li>based on the trip-id the server can lookup the predefined route and determine the next upcoming traffic-light</li><li>the latest signal-phase change times can be queried from the traffic-lights-data API</li><li>based on the received observations, a forecast of future phase changes can be created</li><li>the forecast is used to determine the movement speed necessary to catch the next reachable green phase and that information is returned to the client</li><li>whenever the client location updates, a new GLOSA-request is sent (see step <em>1.</em>, limited to at most 1 request per second)</li></ol><p>For the proof-of-concept, the initial route configuration is done manually by importing a defined route (.gpx format), and by identifying relevant traffic-light IDs with help of the <a href=https://geoportal-hamburg.de/geo-online/>geo-portal</a>.</p><p>The next screenshot shows a minimal web UI which provides information about the current location of the device, the next traffic-light (currently showing red), as well as the speed recomendation (<em>&ldquo;slow down, its not getting green anytime soon..&rdquo;</em>):</p><p><img loading=lazy src=img/run_tour_log_red_too_fast.png alt=too_fast_still_red></p><p>After slowing down, the signal switched to green a few seconds later, and the current speed is now sufficient to catch the phase:</p><p><img loading=lazy src=img/run_tour_keep_to_catch_green.png alt=keep_speed_to_catch_green></p><p>Manual testing (speed set to 20 km/h):</p><video style=width:100% autoplay loop controls src=img/simulated_movement.mp4 type=video/mp4>
There should have been a video here but your browser does not seem
to support it.</video><h3 id=used-technologies>Used technologies<a hidden class=anchor aria-hidden=true href=#used-technologies>#</a></h3><p>Client built with React <a href=https://github.com/mui/material-ui>Material UI components</a>, <a href=https://github.com/remix-run/react-router>react-router</a>, <a href=https://github.com/Leaflet/Leaflet>Leaflet</a> for map display and interaction (via <a href=https://github.com/PaulLeCam/react-leaflet>react-leaflet</a>), and the browser <a href=https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API>Geolocation API</a> (consent and secure context required).<br>Since the Geolocation API does not work in the background a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API>wakelock</a> can be requested.</p><p>Server-side: <a href=https://github.com/nginx/nginx>nginx</a> for basic authentication, ssl-termination, static frontend file serving, and <em>/api</em>-request forwarding.<br>A &ldquo;main backend service&rdquo; is used for central calculations and the &ldquo;orchestration&rdquo; of auxiliary services, built with <a href=https://github.com/spring-projects/spring-boot>Spring Boot</a> (which recently released the amazing support for compiling to a native-image, even though some <a href=https://stackoverflow.com/q/75096690/13156126>stumbling blocks</a> remain).<br>Access to the latest traffic-light data using <a href=https://github.com/expressjs/express>express</a> running on <a href=https://github.com/nodejs/node>node.js</a>.<br>Future phase change times are forecasted based on the (naive) expectation of average-length phases, implemented in Python with <a href=https://github.com/pandas-dev/pandas>pandas</a> and exposed via <a href=https://github.com/pallets/flask>flask</a>.</p><p>For simple testing during development, the public <a href=https://github.com/localtunnel/localtunnel>localtunnel</a> service can be used.</p><p>(The repository is available <a href=https://github.com/fladdimir/radapp>on github</a>).</p><h3 id=performance-considerations>Performance considerations<a hidden class=anchor aria-hidden=true href=#performance-considerations>#</a></h3><p>As the sketched system relies on frequent client-server-communication (~1 request per client per second), performant request handling is important.</p><p>For an analysis of server-side request processing, the <a href=https://opentelemetry.io/>open telemetry project</a> provides standard tooling to gather tracing information for nested requests to different backend services (database, traffic-lights data API, forecasting service).</p><p>Instrumentation support for automatic trace collection and forwarding to a tracing analysis backend are available for many popular languages / frameworks.
For the main Java service, the <a href=https://github.com/open-telemetry/opentelemetry-java-instrumentation>Java instrumentation agent</a> is used, which injects bytecode so that tracing information is automatically collected for popular frameworks / libraries without any code changes.
Similar auto-instrumentation functionality is available for the <a href=https://opentelemetry.io/docs/instrumentation/js/getting-started/nodejs/>node.js</a> based traffic-lights data API proxy service, and for the <a href=https://opentelemetry.io/docs/instrumentation/python/automatic/agent-config/>Python</a>-based forecast-service.</p><p>Processing of a single GLOSA-request:</p><p><a href=img/trace_without_api_proxy_cache.png><img loading=lazy src=img/trace_without_api_proxy_cache.png alt=trace_without_api_proxy_cache></a></p><p>The complete POST to the main backend (<em>locationtracking-0.0.1-SNAPSHOT</em>) takes 105ms to complete, starting with a database accesses (first ~10ms),
followed by a long-running 69ms call to the traffic-lights data API proxy service (<em>tld_api</em>),
and a 14ms call to the forecasting service (<em>tld_forecast</em>).
The main share of the overall request processing time is caused by the call to the external traffic-lights data API (68ms), out of which creating the TCP connection and completing the TLS handshake alone require 39ms.</p><p>To improve performance and efficiency of the external data API access, the subscription feature of the sensorthings API is used.
Apart from the normal HTTP-API to access historical data of traffic-light signal phase changes, a (websocket-based) MQTT-API allows to subscribe to new updates of specific traffic-lights.</p><p><a href=img/api_proxy_cache.drawio.png><img loading=lazy src=img/api_proxy_cache.drawio.png alt=api_proxy_cache></a></p><ol><li>an initial request of the last N signal phase change timestamps causes a regular HTTP request to the external API to fetch the required observations</li><li>furthermore, the received data is cached, and an MQTT-subscription for future updates is created</li><li>each received update is used to update the cache (evicting the oldest entry)</li><li>each following client-request for the same traffic-light data can now immediately be answered with locally cached data, without causing any external API request</li><li>after a configurable time without any client requests for data of a specific traffic-light (e.g. 60s), its subscription is canceled and its cache is cleared (a following client request is again causing an initial external request (<em>1.</em>))</li></ol><p>The following screenshot shows the processing of a subsequent client request for the same traffic-light data:</p><p><a href=img/trace_with_api_proxy_cache.png><img loading=lazy src=img/trace_with_api_proxy_cache.png alt=trace_with_api_proxy_cache></a></p><p>The request to the <em>tld_api</em> is processed within 3ms without any external call.</p><p>To reduce the calculation effort of the route snapping, the index of the last reached route-segment is submitted back to the client as part of the response, and the information is included into the following request.
This way, the number of checked route-segments can be limited (based on the assumption that a client is not expected to move backwards on a route).</p><h3 id=experimental-evaluation>Experimental evaluation<a hidden class=anchor aria-hidden=true href=#experimental-evaluation>#</a></h3><p>To quantify the effects of using the GLOSA app, the geolocation and speed data is sent with each request was persisted for analysis.</p><p>Speed profile of a bike ride <em>without</em> GLOSA speed recommendations:</p><p><a href=img/tour_14156.gif><img loading=lazy src=img/tour_14156.gif alt=tour_14156></a></p><p>The trip had a duration of 00:32:16, and during this time 1,937 samples were collected (one GPS update per second).<br>The theoretical distance measured on a map is 10.7 km, the total sum of the distances between all sampled locations is 11.1 km (slightly longer, probably due to GPS inaccuracies and seemingly &ldquo;less straight&rdquo; movements).<br>The average speed was 5.53 m/s (19.90 km/h).
This is close to the average speed calculated from the 1,937 speed samples (5.38 m/s), so the measurements seem to be quite accurate.<br>The maximum measured speed was 9.30 m/s (33.47 km/h), the share of samples with a measured speed below 1 km/h (likely stops) was 10.8%.</p><p>Trip <em>with</em> GLOSA recommendations:</p><p><a href=img/tour_14164.png><img loading=lazy src=img/tour_14164.png alt=tour_14164></a></p><p>The share of speed measurements below 1 km/h is still 9.2% - a difference of 1.6 percentage points which may not be interpreted to be of any significance.</p><p>An extended evaluation should be based on a larger number of trips.
(Furthermore, the experiment itself was probably also negatively influenced by existing experience on the typical phase lengths.)</p><p>The effect of using the GLOSA app is negatively influenced by:</p><ul><li>outdated traffic light data for some traffic lights (the &ldquo;real-time&rdquo; data is so old that no meaningful predications can be made)</li><li>badly correlated traffic lights (no matter how slow/quick you try to go, between some traffic lights stops are almost inevitable; the phases seem to be optimized for a limited number of cars driving 50 km/h)</li><li>&ldquo;Bedarfsampeln&rdquo; (one traffic light on the route only switches to green upon manual triggering, thus also causing unavoidable stops)</li><li>volatile phase lenghts (forecasts purely based on historical data tend to be rather inaccurate, given the dynamic, adaptive traffic control)</li></ul><p>Especially the last point causes a particularly frustrating experience in case a green phase could actually have easily been catched when <em>not</em> following a recommendation.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://fladdimir.github.io/tags/java/>Java</a></li><li><a href=https://fladdimir.github.io/tags/spring/>Spring</a></li><li><a href=https://fladdimir.github.io/tags/react/>React</a></li><li><a href=https://fladdimir.github.io/tags/typescript/>TypeScript</a></li><li><a href=https://fladdimir.github.io/tags/leaflet.js/>Leaflet.js</a></li><li><a href=https://fladdimir.github.io/tags/tracing/>Tracing</a></li><li><a href=https://fladdimir.github.io/tags/mqtt/>MQTT</a></li><li><a href=https://fladdimir.github.io/tags/nodejs/>NodeJS</a></li><li><a href=https://fladdimir.github.io/tags/ogc-sensorthings-api/>OGC SensorThings API</a></li></ul><nav class=paginav><a class=prev href=https://fladdimir.github.io/post/orm-tracing/><span class=title>« Prev</span><br><span>Tracing ORM Performance Issues</span></a>
<a class=next href=https://fladdimir.github.io/post/testing-legacy-code/><span class=title>Next »</span><br><span>Testing Legacy Software</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://fladdimir.github.io/>wh</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>